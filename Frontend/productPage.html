<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Jost:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
    rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <link href="assets/css/style.css" rel="stylesheet">

  <link href="./logos/Beauty -landing logo.png" rel="icon">
  <link rel="stylesheet" href="./assets/css/productPage.css">
  <!-- ************Auto Typing*************** -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.0.11/typed.min.js"></script>

  <title>Beautygem Product</title>
</head>

<body>
  <div class="p-nav">
    <div class="logo">
      <img id="logo" style="cursor: pointer;" src="logos/BeautygemLogo.png" alt="logo">
    </div>
    <div class="search">
      <input type="text" placeholder="Search salons...">
      <button>Search</button>
    </div>
    <div class="name">
      <!-- add Person name -->
      <!-- <h3>PR</h3>  Removed hardcoded name -->
      <h3 id="user-name"></h3> <!-- Added an element to display the user's name -->

    </div>
  </div>
  <div id="detail">
    <!-- Content will be dynamically inserted here -->
  </div>
  <div class="auto-type">
    <h1 style="font-weight: 700;"><span class="typing"></span></h1>
  </div>
  <!-- Product card -->
  <div id="nodata">
    <!-- data not found -->
  </div>
  <div class="product" id="product">
    <!-- Product cards will be dynamically inserted here -->
  </div>

  <!-- Debug Button (Keep for development, remove or comment out for production) -->
  <div style="text-align: center; margin: 20px;">
    <button onclick="seedDatabase()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">Seed Database</button>
  </div>

  <!-- ======= Footer ======= -->
  <footer id="footer">

    <div class="footer-newsletter">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-lg-6">
            <h4>Join Our Newsletter</h4>
            <p>Tamen quem nulla quae legam multos aute sint culpa legam noster magna</p>
            <form action="" method="post">
              <input type="email" name="email"><input type="submit" value="Subscribe">
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="footer-top">
      <div class="container">
        <div class="row">

          <div class="col-lg-3 col-md-6 footer-contact">
            <h3><span><img width="70%" style="margin-left: -10px;" src="./logos/BeautygemLogo.png" alt=""></span></h3>
            <p>
              A108 Adam Street <br>
              New York, NY 535022<br>
              United States <br><br>
              <strong>Phone:</strong> +1 5589 55488 55<br>
              <strong>Email:</strong> info@example.com<br>
            </p>
          </div>

          <div class="col-lg-3 col-md-6 footer-links">
            <h4>Useful Links</h4>
            <ul>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Home</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">About us</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Services</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Terms of service</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Privacy policy</a></li>
            </ul>
          </div>

          <div class="col-lg-3 col-md-6 footer-links">
            <h4>Our Services</h4>
            <ul>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Web Design</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Web Development</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Product Management</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Marketing</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Graphic Design</a></li>
            </ul>
          </div>

          <div class="col-lg-3 col-md-6 footer-links">
            <h4>Our Social Networks</h4>
            <p>Cras fermentum odio eu feugiat lide par naso tierra videa magna derita valies</p>
            <div class="social-links mt-3">
              <a href="#" class="twitter"><i class="bx bxl-twitter"></i></a>
              <a href="#" class="facebook"><i class="bx bxl-facebook"></i></a>
              <a href="#" class="instagram"><i class="bx bxl-instagram"></i></a>
              <a href="#" class="google-plus"><i class="bx bxl-skype"></i></a>
              <a href="#" class="linkedin"><i class="bx bxl-linkedin"></i></a>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="container footer-bottom clearfix">
      <div class="copyright">
        &copy; Copyright <strong><span>Beautygem</span></strong>. All Rights Reserved
      </div>
      <div class="credits">
        Designed by <a href="#">Beautygem Team</a>
      </div>
    </div>
  </footer><!-- End Footer -->

  <!-- Vendor JS Files -->
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="assets/vendor/waypoints/noframework.waypoints.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>

  <script>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const place = urlParams.get('location') || 'Chittaranjan';
    const service = urlParams.get('service') || 'Hair';
    let globalData = [];

    console.log('URL Parameters:', {
      location: place,
      service: service,
      token: localStorage.getItem("token") ? "Token exists" : "No token"
    });

    // Auto typing effect
    var typed = new Typed(".typing", {
      strings: ["Find Your Perfect Salon", "Book Your Style", "Look Your Best"],
      typeSpeed: 100,
      backSpeed: 60,
      loop: true
    });

    // Function to fetch user data (for the user's name)
    async function fetchUserData() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          console.log('No token found, user not logged in.');
          return; // Don't proceed if there's no token
        }

        const response = await fetch('http://localhost:8080/user/profile', {  // Replace with your actual user profile endpoint
          method: 'GET',
          headers: {
            'Authorization': token,
          },
        });

        if (response.ok) {
          const userData = await response.json();
          document.getElementById('user-name').textContent = userData.name || "User"; // Update the user's name
           //Update the user's name
          console.log(userData.name)
        } else {
          console.error('Failed to fetch user data:', response.status);
        }
      } catch (error) {
        console.error('Error fetching user data:', error);
      }
    }

    // Seed Database Function (Keep for development)
    async function seedDatabase() {
      try {
        console.log('Seeding database...');
        const res = await fetch('http://localhost:8080/product/seed', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': localStorage.getItem('token')
          }
        });

        const data = await res.json();
        console.log('Seed response:', data);
        alert('Database seeded successfully! Refreshing page...');
        location.reload();
      } catch (error) {
        console.error('Error seeding database:', error);
        alert('Error seeding database. Please try again.');
      }
    }

    // Fetch Salon Data
    async function getData() {
      try {
        console.log(`Fetching data from: http://localhost:8080/product/search?location=${place}`);

        let res = await fetch(`http://localhost:8080/product/search?location=${place}`, {
          headers: {
            "Content-type": "application/json",
            "Authorization": localStorage.getItem("token")
          }
        });

        console.log('Response status:', res.status);
        console.log('Response headers:', res.headers);

        let pro_data = await res.json();
        console.log('Received data:', pro_data);

        if (!Array.isArray(pro_data)) {
          console.error('Invalid data format:', typeof pro_data);
          throw new Error('Invalid response format');
        }

        globalData = [...pro_data]; // Correct way to copy the array

        if (pro_data.length === 0) {
          console.log('No results found for location:', place);
          document.getElementById('nodata').innerHTML = `<div style="text-align: center; margin: 20px;">
            <h2>No salons found in ${place}</h2>
            <p>Try searching in a different location</p>
          </div>`;
        } else {
          console.log('Found', pro_data.length, 'salons');
          document.getElementById('nodata').innerHTML = ''; // Clear "no data" message
           render(pro_data); //moved render inside else
           detaileData(pro_data); //moved detaileData
        }

       //Moved inside getData
      } catch (error) {
        console.error('Error in getData:', error);
        if (!localStorage.getItem("token")) {
          console.log('No token found, redirecting to login');
          alert("Please login to view salons");
          window.location.href = "login.html";
        } else {
          console.error('API Error:', error);
          alert("Error fetching salon data. Please try again.");
        }
      }
    }

    // Render Detail Data
    function detaileData(pro_data) {
      console.log('Rendering details for', pro_data.length, 'items');
      let cont = document.querySelector("#detail");
      cont.innerHTML = `
        <div class="total-pro">
          <p>${place} - ${service}</p>
          <h1>${pro_data.length} results for ${service} in ${place}</h1>
          <div class="pro-recomend">
            <p>Recommended</p>
            <div></div>
          </div>
        </div>`;
    }

    // Render Salon Cards
   function render(pro_data) {
    console.log('Rendering', pro_data.length, 'salons');
    let container = document.querySelector("#product");
    container.innerHTML = "";

    if (!pro_data || pro_data.length === 0) {  // Added check for pro_data itself
        console.log('No data to render');
        container.innerHTML = `<p>No salons found matching your criteria.</p>`; // Or any other appropriate message
        return;
    }
    let html = pro_data.map(item => {
        console.log('Rendering salon:', item.name);
        // Use a default rating if item.rating is undefined or null
        const rating = item.rating || 4.5;
        // Use a default review count
        const reviews = item.reviews || Math.floor(Math.random() * 5000) + 1000;

        return `
        <div class="p-card" onclick="window.location.href='singlePage.html?id=${item._id}'">
            <img class="store" src="${item.image || 'https://plus.unsplash.com/premium_photo-1661764393655-667ecb7d63c0?q=80&w=2070&auto=format&fit=crop'}" alt="store_image">
            <h3>${item.name}</h3>
            <p>${item.location}</p>
            <div class="rating">
                <img src="./logos/star.png" alt="rating">
                <p>${rating.toFixed(1)}</p>
                <h5>(${reviews}) Reviews</h5>
            </div>
        </div>`;
    }).join('');

    container.innerHTML = html;
    console.log('Render complete');
}


    // Search Functionality
    const searchInput = document.querySelector('.search input');
    const searchButton = document.querySelector('.search button');

    if (!searchInput || !searchButton) {
      console.error('Search elements not found');
    }

    searchButton.addEventListener('click', () => {
      console.log('Search initiated');
      const searchTerm = searchInput.value.trim();
      if (searchTerm) {
        console.log('Searching for:', searchTerm);
        const filteredData = globalData.filter(item =>
          item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          item.location.toLowerCase().includes(searchTerm.toLowerCase())
        );
        console.log('Found', filteredData.length, 'matches');

        if(filteredData.length === 0) {
            document.getElementById('nodata').innerHTML = `<div style="text-align: center; margin: 20px;">
                <h2>No salons found matching "${searchTerm}"</h2>
                <p>Try a different search term</p>
            </div>`;
            document.getElementById('product').innerHTML = ''; // Clear previous results
        } else {
            document.getElementById('nodata').innerHTML = ''; // Clear "no data" message
            render(filteredData);
        }
        detaileData(filteredData);

      } else {
        // If search term is empty, display all data
        render(globalData);
        detaileData(globalData);
      }
    });

    // Logo Click Handler
    document.querySelector("#logo").addEventListener("click", () => {
      console.log('Redirecting to index');
      window.location.href = "index.html";
    });

    // Initialize
    console.log('Initializing page');
      fetchUserData(); // Fetch user data first
      getData();

  </script>
</body>

</html>